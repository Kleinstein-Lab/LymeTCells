---
title: "Ligand-Receptor Signaling"
output:
  html_document:
    code_download: yes
    code_folding: hide
    css: ../../"style.css"
    dev: "png"
    df_print: kable
    fig_caption: yes
    keep_md: no
    self_contained: true
    theme: yeti
    toc: yes
    toc_depth: 4
    toc_float:
        collapsed: false
        smooth_scroll: false
editor_options: 
  chunk_output_type: console
---

------------------------------------------------------------------------

# Overview and setup

```{r setup-options, include = FALSE}
knitr::opts_chunk$set(comment = NA, dpi = 200, fig.align = "center",
                      out.width = "100%", warning = FALSE, error = TRUE,
                      message = FALSE,
                      fig.path = here::here("primary_analysis", "figures",
                                            "downstream", "signaling",
                                            "signaling-"))

# will mess with chunk labels, but needed for parameterized reports
options(knitr.duplicate.label = "allow")
```

**Author(s):** Edel Aron, Paraskevas Filippidis<br>
**Last Updated:** `r Sys.Date()`

**R version:** `r R.Version()$version.string`<br>
**Platform:** `r R.Version()$platform`<br>
**Running under:** `r sessionInfo()$running`

```{r, include = FALSE}
# load packages, colors and themes and functions (R code only)
code_setup <-
  knitr::purl(here::here("primary_analysis", "notebooks", "01-setup.Rmd"),
              output = tempfile(), documentation = 0)
code_functions <-
  knitr::purl(here::here("primary_analysis", "notebooks", "02-functions.Rmd"),
              output = tempfile(), documentation = 0)
code_meta <- 
  knitr::purl(here::here("primary_analysis", "notebooks", "03-meta.Rmd"),
              output = tempfile(), documentation = 0)

# read in the code, then remove the temp files
source(code_setup)
source(code_functions)
source(code_meta)
unlink(c(code_setup, code_functions, code_meta))
```

```{r load}
# devtools::install_github("jinworks/CellChat")

# devtools::install_github("renozao/pkgmaker")
# devtools::install_github("sqjin/NMF") or install.packages("NMF")
# devtools::install_github("renozao/NMF@devel") # this one works correctly
# source('http://renozao.github.io/repotools/install.R')

# load NMF first (it is needed by CellChat)
packages <- c("NMF", "CellChat", "future")
for (n in seq_along(packages)) {
  suppressPackageStartupMessages(library(packages[n], character.only = TRUE))
  cat(paste0(packages[n], ": ", packageVersion(packages[n]), "\n"))
}
```

Got some code from [Fabian's tutorial](https://theislab.github.io/interaction-tools/14-CellChat.html).

------------------------------------------------------------------------

# Read in the data

## GEX

```{r setup-gex}
combined_skin_recombined <-
  readRDS(file.path(path_objs, "final", "combined_skin_recombined_t.rds"))

colors_annotated_skin_recombined <-
  combined_skin_recombined@misc$colors_annotated
```

## CellChat

```{r setup-cellchat}
cellchat_list <- readRDS(file.path(path_objs, "downstream", "signaling",
                                   "cellchat_list.rds"))
cellchat_merged <- readRDS(file.path(path_objs, "downstream", "signaling",
                                     "cellchat_merged.rds"))
```

------------------------------------------------------------------------

# Run CellChat

Credit to Paris for the updated code:

```{r}
#| eval = FALSE

# set the Seurat object and CellChat parameters (adjust as needed)
annotation_col <- "annotated_clusters_expanded"
min_cells <- 10
seurat_assay <- "RNA"
species <- "human"
workers <- 8
future_mem_gb <- 5

# reduce the Seurat object's sample size for faster computation
CellChatDB <- CellChatDB.human # comes with the package
genes_use <-
  unique(c(CellChatDB$interaction$ligand, CellChatDB$interaction$receptor))
genes_keep <- intersect(genes_use, rownames(combined_skin_recombined))
combined_skin_recombined_diet <-
  DietSeurat(object = combined_skin_recombined, features = genes_keep,
             data = TRUE, assays = "RNA", dimreducs = NULL, # drop PCA & UMAP
             graphs = NULL) # drop neighbor graphs

# create separate objects for the EM and control
seurat_list <-
  SplitObject(combined_skin_recombined_diet, split.by = "SampleType")

# parallel processing and memory configuration
options(future.globals.maxSize = future_mem_gb * 1024^3)
old_plan <- future::plan("multisession", workers = workers)
on.exit(future::plan(old_plan), add = TRUE)

# run CellChat over the Seurat list
cellchat_list <- vector("list", length(seurat_list))
names(cellchat_list) <- names(seurat_list)

for (group in names(seurat_list)) {
  message(sprintf("\n=== Processing: %s ===", group))
  obj <- seurat_list[[group]]

  # convert annotations from factor to character
  if (is.factor(obj[[]][[annotation_col]])) {
    obj[[]][[annotation_col]] <- as.character(obj[[]][[annotation_col]])
  }

  # create the CellChat object
  cellchat <- createCellChat(object = obj, group.by = annotation_col,
                             assay = seurat_assay)
  cellchat@DB <- CellChatDB

  # preprocess the object and run the workflow
  cellchat <- subsetData(cellchat)
  cellchat <- identifyOverExpressedGenes(cellchat)
  cellchat <- identifyOverExpressedInteractions(cellchat)
  cellchat <- computeCommunProb(cellchat, type = "triMean",
                                population.size = FALSE)
  cellchat <- filterCommunication(cellchat, min.cells = min_cells)
  cellchat <- computeCommunProbPathway(cellchat)
  cellchat <- aggregateNet(cellchat)

  # save the object in the list
  cellchat_list[[group]] <- cellchat
}

# set controls as the first group in the list before merging objects
cellchat_list <- cellchat_list[c(2, 1)]

# compute the centrality scores for later downstream analysis
cellchat_list <- lapply(cellchat_list, function(obj) {
  netAnalysis_computeCentrality(obj, slot.name = "netP")
})

# merge the CellChat objects into one object for comparative analysis
# the names of the groups will be added as new metadata
cellchat_merged <-
  mergeCellChat(cellchat_list, add.names = names(cellchat_list))

# save objects
saveRDS(cellchat_list,
        file.path(path_objs, "downstream", "signaling", "cellchat_list.rds"))
saveRDS(cellchat_merged,
        file.path(path_objs, "downstream", "signaling", "cellchat_merged.rds"))
```

Identify up- and down-regulated signaling receptors:

```{r}
# define a positive dataset
# i.e., the dataset with positive fold change against the other dataset
pos_dataset = "EM"
# define a char name used for storing differential expression analysis results
features_name = paste0(pos_dataset, ".DGE")

# perform differential expression analysis 
# compared to CellChat version < v2, CellChat v2 now performs an ultra-fast Wilcoxon test using the presto package, which gives smaller values of logFC
# thus we here set a smaller value of thresh.fc compared to the original one (thresh.fc = 0.1)
# users can also provide a vector and dataframe of customized DEGs by modifying the cellchat_merged@var.features$LS.merged and cellchat_merged@var.features$LS.merged.info
cellchat_merged <-
  identifyOverExpressedGenes(cellchat_merged, group.dataset = "datasets",
                             pos_dataset = pos_dataset,
                             features_name = features_name, only.pos = FALSE,
                             thresh.pc = 0.1, thresh.fc = 0.05, thresh.p = 0.05, 
                             group.DE.combined = FALSE) 

# map the results of differential expression analysis onto the inferred cell-cell communications to easily manage/subset the ligand-receptor pairs of interest
net <- netMappingDEG(cellchat_merged, features_name = features_name,
                     variable.all = TRUE)

# extract the ligand-receptor pairs with up-regulated ligands in EM
net_up <- subsetCommunication(cellchat_merged, net = net, datasets = "EM",
                              ligand.logFC = 0.05, receptor.logFC = NULL)

# extract the ligand-receptor pairs with up-regulated ligands and up-regulated receptors in Control, i.e. down-regulated in EM
net_down <- subsetCommunication(cellchat_merged, net = net, datasets = "Control",
                                ligand.logFC = -0.05, receptor.logFC = NULL)

# perform further deconvolution to obtain individual signaling genes
gene_up <- extractGeneSubsetFromPair(net_up, cellchat_merged)
gene_down <- extractGeneSubsetFromPair(net_down, cellchat_merged)
```

------------------------------------------------------------------------

# Visualization

## Cell-cell interactions

```{r}
# set cell types of interest
cells_focus <- c("CD8+ GZMK+ IFNGhi T Cells", "CD8+ GZMK+ IFNGint T Cells")
cells_skin <- c("Endothelial Cells", "Fibroblasts", "Keratinocytes",
                "Mast Cells", "Melanocytes", "Nerves", "Pericytes")
```

### Circle plots for cell-cell interactions (differential)

```{r}
# plot differential circle plot
par(mfrow = c(2, 2), xpd = TRUE)
netVisual_diffInteraction(cellchat_merged, 
                          sources.use = cells_focus,
                          targets.use = cells_skin,
                          weight.scale = TRUE, measure = "count",
                          title.name = "Differential Number of Interactions \nSenders: CD8+ GZMK+ T cells - Receivers: Skin Cells",
                          remove.isolate = FALSE)

netVisual_diffInteraction(cellchat_merged, 
                          sources.use = cells_focus,
                          targets.use = cells_skin,
                          weight.scale = TRUE, measure = "weight",
                          title.name = "Differential Strength of Interactions \nSenders: CD8+ GZMK+ T cells - Receivers: Skin Cells",
                          remove.isolate = FALSE)

netVisual_diffInteraction(cellchat_merged, 
                          sources.use = cells_skin,
                          targets.use = cells_focus,
                          weight.scale = TRUE, measure = "count",
                          title.name = "Differential Number of Interactions \nSenders: Skin Cells - Receivers: CD8+ GZMK+ T cells",
                          remove.isolate = FALSE)

netVisual_diffInteraction(cellchat_merged, 
                          sources.use = cells_skin,
                          targets.use = cells_focus,
                          weight.scale = TRUE, measure = "weight",
                          title.name = "Differential Strength of Interactions \nSenders: Skin Cells - Receivers: CD8+ GZMK+ T cells",
                          remove.isolate = FALSE)
```

### Circle plots for cell-cell interactions (non-differential / per condition)

GzmK T cells as senders and skin cells as receivers:

```{r}
weight_max <- getMaxWeight(cellchat_list, attribute = c("idents", "count"))
par(mfrow = c(2, 2), xpd = TRUE)

# by count
for (i in 1:length(cellchat_list)) {
  netVisual_circle(cellchat_list[[i]]@net$count, weight.scale = TRUE,
                   label.edge = FALSE, 
                   sources.use = cells_focus, targets.use = cells_skin,
                   edge.weight.max = weight_max[2], edge.width.max = 12,
                   vertex.weight = as.numeric(table(cellchat_list[[i]]@idents)),
                   title.name = paste("Number of interactions -",
                                      names(cellchat_list)[i]))
}

# by strength
weight_max <- getMaxWeight(cellchat_list, attribute = c("idents", "weight"))
for (i in 1:length(cellchat_list)) {
  netVisual_circle(cellchat_list[[i]]@net$weight, weight.scale = TRUE,
                   label.edge = FALSE,
                   sources.use = cells_focus, targets.use = cells_skin,
                   edge.weight.max = weight_max[2], edge.width.max = 12,
                   vertex.weight = as.numeric(table(cellchat_list[[i]]@idents)),
                   title.name = paste("Strength of interactions -",
                                      names(cellchat_list)[i]))
}
```

Skin cells as senders and GzmK T cells as receivers:

```{r}
# plot interactions with 
weight_max <- getMaxWeight(cellchat_list, attribute = c("idents", "count"))
par(mfrow = c(2, 2), xpd = TRUE)

# by count
for (i in 1:length(cellchat_list)) {
  netVisual_circle(cellchat_list[[i]]@net$count, weight.scale = TRUE,
                   label.edge = FALSE, 
                   sources.use = cells_skin, targets.use = cells_focus,
                   edge.weight.max = weight_max[2], edge.width.max = 12,
                   vertex.weight = as.numeric(table(cellchat_list[[i]]@idents)),
                   title.name = paste("Number of interactions -",
                                      names(cellchat_list)[i]))
}

# weight
weight_max <- getMaxWeight(cellchat_list, attribute = c("idents", "weight"))
for (i in 1:length(cellchat_list)) {
  netVisual_circle(cellchat_list[[i]]@net$weight, weight.scale = TRUE,
                   label.edge = FALSE,
                   sources.use = cells_skin, targets.use = cells_focus,
                   edge.weight.max = weight_max[2], edge.width.max = 12,
                   vertex.weight = as.numeric(table(cellchat_list[[i]]@idents)),
                   title.name = paste("Strength of interactions -",
                                      names(cellchat_list)[i]))
}
```

### Chord diagrams for differential LR in GzmK T cells

*Note that you could try the function `netVisual_chord_cell()` for visualizing individual signaling pathways.*

GzmK T cells as receivers:

```{r}
par(mfrow = c(1, 2), xpd = FALSE)

netVisual_chord_gene(cellchat_list[[2]], 
                     sources.use = NULL, targets.use = cells_focus,
                     slot.name = "net", net = net.up, lab.cex = 1.2,
                     small.gap = 1, 
                     title.name = paste("Up-regulated signaling in", 
                                        names(cellchat_list)[2],
                                        "- Receivers: GZMK T cells"))

netVisual_chord_gene(cellchat_list[[1]], 
                     sources.use = NULL, targets.use = cells_focus,
                     slot.name = "net", net = net.down, lab.cex = 1.2,
                     small.gap = 1, 
                     title.name = paste("Down-regulated signaling in",
                                        names(cellchat_list)[2],
                                        "- Receivers: GZMK T cells"))
```

GzmK T cells as senders:

```{r}
par(mfrow = c(1, 2), xpd = FALSE)

netVisual_chord_gene(cellchat_list[[2]], 
                     sources.use = cells_focus, targets.use = NULL,
                     slot.name = "net", net = net.up, lab.cex = 1.2,
                     small.gap = 1, 
                     title.name = paste("Up-regulated signaling in",
                                        names(cellchat_list)[2],
                                        "- Receivers: GZMK T cells"))

netVisual_chord_gene(cellchat_list[[1]], 
                     sources.use = cells_focus, targets.use = NULL,
                     slot.name = "net", net = net.down, lab.cex = 1.2,
                     small.gap = 1, 
                     title.name = paste("Down-regulated signaling in",
                                        names(cellchat_list)[2],
                                        "- Receivers: GZMK T cells"))
```

## Cell-cell communication pathways

### Circle plots with cell-cell interactions for specific pathways

```{r}
pathways.show <-  c("CXCL", "CCL")

# reset graphics device cleanly
try(graphics.off(), silent = TRUE)
if (names(dev.cur()) == "null device") {
  nr <- length(pathways.show)
  nc <- length(cellchat_list)
  dev.new(width = 4 * nc, height = 3.5 * nr)
}

# safe per-pathway max (handles missing pathways)
weight_max <- setNames(
  sapply(pathways.show, function(p) {
    max(sapply(cellchat_list, function(obj) {
      ok <- !is.null(obj@netP) && !is.null(obj@netP$prob) &&
            !is.null(dimnames(obj@netP$prob)[[3]]) &&
            p %in% dimnames(obj@netP$prob)[[3]]
      if (ok) max(obj@netP$prob[,, p], na.rm = TRUE) else 0
    }), na.rm = TRUE)
  }),
  pathways.show
)

# plot grid + error-guard each panel
op <- par(no.readonly = TRUE); on.exit(par(op), add = TRUE)
# fills columns first, then rows
par(mfcol = c(length(cellchat_list), length(pathways.show)),
    xpd = TRUE, mar = c(1.5, 1.5, 3, 1))

for (p in pathways.show) {
  for (i in seq_along(cellchat_list)) {
    obj <- cellchat_list[[i]]
    dataset_name <- if (!is.null(names(cellchat_list))) names(cellchat_list)[i] else paste0("set", i)

    # map to the labels you want to see
    dataset_label <- switch(dataset_name, "control" = "PWoH", "case" = "PWH",
                            "PWoH" = "PWoH", "PWH" = "PWH", dataset_name)

    has_path <- !is.null(obj@netP) && !is.null(obj@netP$pathways) &&
                p %in% obj@netP$pathways

    tryCatch({
      if (has_path) {
        # use signaling.name for the full title; do not pass title.name here
        netVisual_aggregate(obj, signaling = p, layout = "circle",
                            edge.weight.max = weight_max[[p]],
                            edge.width.max  = 10,
                            vertex.label.cex = 1.3,
                            color.use = colors_annotated_skin_recombined,
                            signaling.name = paste(p, "in", dataset_label))
      } else {
        # empty panel with same nodes, no edges
        groups <- levels(obj@idents)
        mat0 <- matrix(0, length(groups), length(groups),
                       dimnames = list(groups, groups))

        netVisual_circle(mat0, weight.scale = FALSE, label.edge = FALSE,
                         vertex.label.cex = 1.3,
                         color.use = colors_annotated_skin_recombined,
                         # here it's fine to use title.name
                         title.name = paste(p, "in", dataset_label,
                                            "signaling pathway network"))
      }
    }, error = function(e) {
      plot.new()
      title(main = paste0(p, " signaling pathway network in ", dataset_label,
                          "\n(plot failed: ", conditionMessage(e), ")"),
            cex.main = 0.9)
    })
  }
}
```

### Chord diagrams for pathway-specific up- and down-regulated LR pairs

CXCL pathway:

```{r}
# up-regulated L-R pairs in EM
netVisual_chord_gene(cellchat_list[[2]], 
                     sources.use = cells_skin, targets.use = cells_focus,
                     signaling = "CXCL",
                     slot.name = "net", net = net.up, lab.cex = 0.9,
                     small.gap = 3, 
                     color.use = colors_annotated_skin_recombined,
                     title.name = paste("Up-regulated signaling in",
                                        names(cellchat_list)[2]))

# down-regulated L-R pairs in EM
netVisual_chord_gene(cellchat_list[[1]], 
                     sources.use = NULL, targets.use = NULL,
                     signaling = "CXCL",
                     slot.name = "net", net = net.down, lab.cex = 0.9,
                     small.gap = 3, 
                     color.use = colors_annotated_skin_recombined,
                     title.name = paste("Down-regulated signaling in",
                                        names(cellchat_list)[2]))
```

CCL pathway:

```{r}
# up-regulated L-R pairs in EM
netVisual_chord_gene(cellchat_list[[2]], 
                     sources.use = NULL, targets.use = NULL,
                     signaling = "CCL",
                     slot.name = "net", net = net.up, lab.cex = 0.9,
                     small.gap = 3, 
                     color.use = colors_annotated_skin_recombined,
                     title.name = paste("Up-regulated signaling in",
                                        names(cellchat_list)[2]))

# down-regulated L-R pairs in EM
netVisual_chord_gene(cellchat_list[[1]], 
                     sources.use = NULL, targets.use = NULL,
                     signaling = "CCL",
                     slot.name = "net", net = net.down, lab.cex = 0.9,
                     small.gap = 3, 
                     color.use = colors_annotated_skin_recombined,
                     title.name = paste("Down-regulated signaling in",
                                        names(cellchat_list)[2]))
```
